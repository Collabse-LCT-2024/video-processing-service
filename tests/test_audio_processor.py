import os
import unittest

from embedders.labse_embedder import LabseEmbedder
from embedders.whisper_transcriber import WhisperTranscriber
from processor.audio_precessor import AudioProcessor
from utils.nltk_tokenizer import NLTKTokenizer
from utils.text_summarizer import TextSummarizer
from utils.vdeo_downloader import VideoDownloader


class TestAudioProcessor(unittest.TestCase):
    def setUp(self):
        self.video_downloader = VideoDownloader()
        self.transcriber = WhisperTranscriber()
        self.tokenizer = NLTKTokenizer()
        self.text_summarizer = TextSummarizer(self.tokenizer)
        self.text_embedder = LabseEmbedder()
        self.audio_processor = AudioProcessor(
            self.video_downloader,
            self.transcriber,
            self.text_summarizer,
            self.text_embedder
        )
        self.test_video_url = "https://cdn-st.rutubelist.ru/media/00/02/360ce9c64696aacf0af2af629e57/fhd-wm.mp4"

    def test_process_success(self):
        video_id = "video_1"
        video_link = self.test_video_url

        result_embeddings, result_text = self.audio_processor.process(video_id, video_link)

        self.assertIsNotNone(result_embeddings)
        self.assertIsInstance(result_embeddings.tolist(), list)
        self.assertIsNotNone(result_text)
        self.assertIsInstance(result_text, str)
        self.assertTrue(len(result_text) > 0)

        print(result_embeddings.tolist() == [-0.04797879606485367, -0.017453167587518692, -0.03652322292327881, 0.008565014228224754, -0.014116993173956871, -0.04885623976588249, -0.027646228671073914, -0.038353707641363144, -0.03469310700893402, -0.03362143039703369, -0.009543226100504398, -0.04886249080300331, -0.061001453548669815, -0.037498798221349716, -0.02293960563838482, -0.049858272075653076, -0.06436881422996521, -0.05423988401889801, -0.0029518494848161936, -0.07352018356323242, -0.05376540496945381, -0.05016357824206352, 0.0044942256063222885, -0.03967146947979927, 0.004456788767129183, -0.005063454154878855, -0.039735663682222366, -0.035689324140548706, -0.02139139734208584, -0.003003516234457493, -0.02562876231968403, -0.038328733295202255, -0.0353628508746624, 0.015320244245231152, -0.0022378857247531414, 0.0024945565965026617, -0.050973206758499146, -0.019240453839302063, -0.025184214115142822, -0.025092625990509987, -0.02249942161142826, 0.026986014097929, -0.0009510692907497287, -0.007807497400790453, -0.028029127046465874, -0.019469553604722023, -0.034470848739147186, -0.02271757461130619, -0.01942223124206066, -0.02207241579890251, -0.030521145090460777, -0.02102033421397209, -0.011634299531579018, -0.023289700970053673, 0.03506945073604584, -0.03591923788189888, -0.040141649544239044, -0.07519356161355972, 0.009942025877535343, -0.04105425253510475, -0.06631866842508316, -0.03989953175187111, -0.05571097508072853, -0.01625286601483822, 0.010158260352909565, -0.034454796463251114, -0.05681055039167404, -0.02480398118495941, -0.03875699266791344, -0.03582998737692833, -0.022874101996421814, -0.04851842299103737, -0.021588867530226707, -0.03264101594686508, -0.031627777963876724, -0.011957482434809208, -0.03033960796892643, -0.01947323977947235, -0.03366010636091232, -0.057785484939813614, -0.043773673474788666, -0.01195591315627098, -0.02980518527328968, -0.019444875419139862, -0.03786580637097359, -0.026088092476129532, 0.006767100188881159, -0.07989043742418289, -0.022170444950461388, -0.0067689246498048306, -0.034122075885534286, -0.024953648447990417, -0.02824329398572445, -0.0015057841083034873, -0.05443848669528961, -0.018448080867528915, -0.007208837661892176, -0.05888945981860161, -0.012529090978205204, -0.02145484834909439, -0.06556567549705505, 0.020553287118673325, -0.04106384888291359, -0.01895252987742424, -0.023774273693561554, -0.015121707692742348, -0.0372854545712471, -0.049795590341091156, 0.008629875257611275, -0.0035372707061469555, -0.03248982131481171, -0.03383839130401611, -0.005948245525360107, -0.041341736912727356, -0.05193137750029564, 0.05027482286095619, -0.035676516592502594, -0.008785380981862545, -0.04888791963458061, -0.006406987551599741, -0.03968871384859085, -0.056483592838048935, -0.04254267364740372, -0.016711393371224403, 0.0014264594065025449, -0.05700969696044922, 0.01642567850649357, -0.056709174066782, 0.020172398537397385, -0.023905038833618164, -0.022446710616350174, -0.03521329537034035, 0.009206325747072697, -0.034254200756549835, -0.015466960147023201, -0.028329692780971527, 0.0008114134543575346, 0.014293844811618328, 0.009818322956562042, -0.039274465292692184, -0.03547578305006027, -0.061599865555763245, -0.004665436688810587, -0.03221234679222107, -0.0356091633439064, 0.0008679738384671509, -0.031089402735233307, -0.02702901139855385, -0.0666397362947464, -0.031830545514822006, -0.042465467005968094, -0.006068924441933632, -0.03599227964878082, -0.05504382401704788, -0.026836030185222626, 0.008396587334573269, 0.0022633809130638838, -0.02085435763001442, -0.026817260310053825, -0.03750472143292427, -0.007664899341762066, -0.04305631294846535, -0.020626483485102654, -0.003666182514280081, -0.0008341370266862214, -0.0027900454588234425, -0.011573469266295433, 0.028520118445158005, -0.013670244254171848, 0.016568372026085854, -0.058373790234327316, -0.04117097333073616, -0.06849157065153122, -0.021977650001645088, -0.08542267978191376, -0.013917430303990841, -0.02168348990380764, -0.029188059270381927, -0.008700357750058174, -0.02227463573217392, -0.04544195160269737, 0.009406703524291515, -0.03167698532342911, 0.0032468128483742476, -0.026471422985196114, -0.05671413987874985, -0.0244975034147501, -0.021672459319233894, -0.03133233264088631, -0.010458960197865963, -0.038853373378515244, -0.03911907225847244, -0.0704210102558136, -0.02974885143339634, -0.08085273206233978, 0.0011193540412932634, -0.05071518197655678, -0.06746122241020203, -0.038459472358226776, -0.031963594257831573, -0.08062086254358292, -0.0076950532384216785, -0.039739180356264114, -0.03714854642748833, -0.01579788140952587, -0.044858068227767944, -0.016664890572428703, -0.03477610647678375, -0.002765539102256298, -0.05576657876372337, -0.04465887323021889, -0.02593994140625, 0.03556999936699867, -0.03505069017410278, -0.07169656455516815, -0.05995149165391922, -0.10534612089395523, -0.02288229763507843, -0.03212442994117737, -0.03879668563604355, -0.01701943390071392, 0.0008387224515900016, -0.04334479570388794, -0.028704604133963585, -0.07205268740653992, -0.06794733554124832, -0.007157184183597565, -0.016917118802666664, -0.05646461248397827, -0.013107459992170334, -0.046691522002220154, -0.05847657471895218, -0.069768026471138, -0.034041933715343475, -0.06859707832336426, -0.033448975533246994, -0.03653400018811226, -0.03633585199713707, -0.0327015183866024, 0.001413671183399856, -0.018205147236585617, 0.001598908449523151, 0.007556665688753128, -0.009170673787593842, -0.052318911999464035, -0.06416215002536774, -0.035022951662540436, -0.0020898685324937105, -0.05456965044140816, -0.009246152825653553, -0.006129344925284386, -0.037435006350278854, -0.041617438197135925, -0.03911830484867096, -0.06241684406995773, 0.03135668486356735, -0.02652815356850624, -0.031888268887996674, -0.03664232790470123, -0.033462367951869965, -0.02767256647348404, -0.026066362857818604, -0.04470048099756241, -0.036763258278369904, -0.0513799786567688, -0.02605765126645565, 0.003924908582121134, -0.05266091972589493, -0.005919756833463907, 0.030737606808543205, -0.018490567803382874, -0.043689414858818054, -0.02978621982038021, -0.07378041744232178, -0.009956290014088154, -0.05450078099966049, -0.015445110388100147, 0.0006863856688141823, 0.004702849313616753, 0.014590383507311344, -0.037443239241838455, -0.0409591980278492, -0.006794196553528309, 0.02588452585041523, 0.027670936658978462, 0.018761252984404564, -0.009333941154181957, -0.009836842305958271, -0.03770265355706215, -0.017199907451868057, -0.03658069670200348, -0.0004032981814816594, -0.017847351729869843, -0.06804858893156052, -0.03821001574397087, -0.04968683049082756, -0.02895083837211132, -0.0348612517118454, -0.02685718983411789, -0.05337518826127052, -0.05725473165512085, -0.030958142131567, -0.03246935084462166, 0.028417369350790977, -0.059698622673749924, -0.05592658370733261, -0.03825901076197624, -0.03779996931552887, -0.056429505348205566, -0.0623788982629776, -0.016432154923677444, -0.009092329069972038, -0.004514142870903015, 0.021482020616531372, -0.024506719782948494, -0.02710389345884323, -0.02886548638343811, 0.00317802419885993, -0.05824332311749458, -0.001512119546532631, -0.02050843834877014, -0.0552489198744297, -0.04037022590637207, -0.03982166573405266, -0.04165079444646835, -0.008149475790560246, -0.02932044491171837, -0.023127906024456024, 0.005284191574901342, -0.033106908202171326, -0.025766020640730858, -0.04070623219013214, -0.052270952612161636, -0.019070956856012344, -0.005836144555360079, -0.05736676976084709, 0.05913430452346802, -0.0305794607847929, -0.04619838669896126, -0.0038777838926762342, -0.0740814059972763, 0.02332221530377865, -0.06903331726789474, -0.0227743461728096, -0.048113711178302765, -0.04229823499917984, -0.028759514912962914, -0.004427854437381029, -0.03605977073311806, -0.049100156873464584, -0.008584889583289623, 0.004990600049495697, -0.03378274291753769, -0.0076301200315356255, -0.03463932126760483, -0.06595933437347412, 0.03141370043158531, -0.038944799453020096, 0.015645386651158333, -0.046872399747371674, -0.0684698075056076, -0.06361772119998932, -0.07487937808036804, -0.03309477120637894, -0.03107181377708912, -0.04681127890944481, 0.016142025589942932, -0.03202198073267937, -0.04611751809716225, -0.003168676281347871, -0.003002663142979145, -0.024789590388536453, -0.05219500511884689, -0.04630392789840698, 0.0066316574811935425, -0.02193135768175125, 0.0031267565209418535, -0.03021809831261635, -0.05254160612821579, -0.03620355576276779, -0.05798729136586189, -0.054367706179618835, 0.003225883701816201, -0.016568120568990707, -0.041833143681287766, 0.003324987133964896, -0.004596313927322626, -0.009615491144359112, -0.038224488496780396, -0.050605446100234985, 0.008089729584753513, 0.02049395628273487, -0.04061247035861015, -0.02811678685247898, -0.06669409573078156, 0.025945493951439857, -0.01153780147433281, -0.04854892939329147, -0.014172598719596863, -0.045352622866630554, -0.020832687616348267, -0.07879085838794708, -0.08144316077232361, -0.044805075973272324, -0.021770276129245758, -0.04557175561785698, -0.005794562865048647, -0.0558476485311985, -0.04483767971396446, 0.0080320555716753, -0.04094679281115532, -0.0230641420930624, -0.036340005695819855, -0.05601239204406738, -0.005745510570704937, -0.022867722436785698, -0.02776928059756756, -0.032640986144542694, 0.0007485118694603443, -0.038664426654577255, -0.021564511582255363, -0.04147251322865486, -0.014637298882007599, -0.01938888616859913, -0.04100964218378067, -0.019697150215506554, -0.01736045442521572, -0.046091288328170776, -0.02932034619152546, -0.028384791687130928, -0.00388100603595376, -0.022839458659291267, -0.048788633197546005, 0.0016335281543433666, -0.010397578589618206, -0.008871988393366337, -0.01422915980219841, -0.08111395686864853, -0.042378995567560196, -0.050084520131349564, -0.008660651743412018, -0.005222503561526537, -0.005194003693759441, -0.034767720848321915, -0.028097501024603844, -0.019073620438575745, -0.057887010276317596, -0.02949630096554756, -0.04824912175536156, -0.049950793385505676, -0.006357213947921991, 0.01815648004412651, -0.01291490439325571, -0.05687703937292099, -0.04498160257935524, -0.014193030074238777, 0.013068982400000095, -0.013232284225523472, -0.013637256808578968, -0.05667296424508095, 0.004932027775794268, -0.01861780509352684, 0.019885698333382607, -0.037865787744522095, -0.021144522354006767, 0.02801712416112423, -0.013823562301695347, -0.05999517813324928, -0.013447489589452744, 0.0011346702231094241, -0.03109131194651127, -0.05348048731684685, -0.02406565099954605, -0.01702498085796833, 0.005462357774376869, -0.027556249871850014, -0.011019147001206875, -0.023234404623508453, -0.019276058301329613, 0.011699704453349113, -0.02604575641453266, -0.051808152347803116, -0.003553965361788869, 0.009499154053628445, -0.020543372258543968, -0.04932653531432152, -0.018773548305034637, 0.007082164287567139, 0.0015786191215738654, -0.0395401306450367, 0.00820938404649496, -0.041617508977651596, -0.01426233071833849, -0.010427949950098991, -0.04718047007918358, -0.02018798515200615, -0.01165683101862669, -0.00014831701992079616, 0.01098323892802, -0.007768931332975626, -0.025736737996339798, -0.01361717190593481, -0.015651892870664597, -0.02287212386727333, -0.02917078509926796, -0.06305446475744247, -0.06877079606056213, -0.0045997039414942265, -0.0019376445561647415, -0.014977745711803436, -0.031033435836434364, -0.039575085043907166, -0.05704624950885773, -0.02591882459819317, -0.0008521937415935099, -0.02859744243323803, -0.03843928128480911, -0.012624403461813927, 0.022595686838030815, 0.021664729341864586, -0.04200249910354614, -0.0023029844742268324, -0.014969302341341972, -0.020245268940925598, -0.01709122024476528, -0.028391147032380104, -0.029056647792458534, -0.03698589280247688, -0.02093151956796646, -0.06030099838972092, 0.004824118688702583, -0.029935015365481377, -0.029719360172748566, 0.01634874753654003, -0.05642092972993851, -0.04747974872589111, -0.04819319024682045, -0.03688263148069382, 0.018139952793717384, -0.05481763184070587, -0.05174564942717552, -0.03215029090642929, -0.03756050020456314, -0.027000511065125465, -0.028686000034213066, -0.031044967472553253, 0.04139019921422005, 0.0011382363736629486, -0.039613988250494, -0.062220439314842224, -0.019782599061727524, -0.03461036831140518, -0.04550148919224739, -0.03709922730922699, -0.028677642345428467, -0.05771689862012863, -0.017234379425644875, -0.02375597320497036, -0.05549979954957962, -0.0522456020116806, 0.002083476632833481, -0.03420080617070198, -0.04887994006276131, -0.0339401438832283, -0.007983867079019547, -0.03101368062198162, -0.003949185833334923, -0.031471531838178635, 0.013976558111608028, -0.06813106685876846, -0.006797831039875746, -0.026931338012218475, -0.061996202915906906, -0.055347174406051636, -0.014138756319880486, -0.04396089166402817, -0.03038117103278637, -0.028968021273612976, -0.004643311258405447, -0.031188104301691055, -0.03207429498434067, -0.032139457762241364, 0.0048151942901313305, -0.04561516270041466, -0.028100788593292236, -0.046322356909513474, -0.022128848358988762, -0.05998367816209793, 0.009415565989911556, -0.0163167342543602, -0.008252328261733055, -0.057636961340904236, -0.028558576479554176, -0.04024025425314903, -0.04861222580075264, 0.009878717362880707, -0.04015384614467621, -0.03871621936559677, -0.06365611404180527, -0.057375285774469376, -0.027963818982243538, -0.05130186304450035, -0.01767265610396862, -0.06266899406909943, 0.001988910371437669, -0.008277305401861668, -0.04064260050654411, -0.04312470927834511, -0.06419545412063599, -0.054445140063762665, -0.008140651509165764, -0.048976145684719086, -0.03321453556418419, -0.03177943453192711, -0.006625309586524963, -0.028738977387547493, -0.02804221399128437, -0.021507486701011658, -0.014739181846380234, -0.019075771793723106, -0.02461455576121807, -0.035149842500686646, -0.049943044781684875, -0.05377301573753357, -0.007335672155022621, -0.03568943217396736, -0.019058672711253166, -0.020213091745972633, -0.039863474667072296, 0.009108987636864185, 0.020446863025426865, -0.03370678052306175, 0.02663266472518444, -0.08127108216285706, -0.004427627194672823, -0.011915462091565132, -0.02082858607172966, -0.03970521688461304, -0.005404753610491753, -0.012309884652495384, -0.04762696847319603, -0.03653065487742424, -0.04890289157629013, -0.024738961830735207, -0.04208579286932945, 0.0011889194138348103, 0.0026264882180839777, -0.01467971969395876, -0.07075212895870209, -0.02440093830227852, -0.05801578611135483, 0.025889480486512184, -0.029876120388507843, -0.02020382136106491, -0.03593038395047188, -0.02982977032661438, -0.03934933617711067, 0.008684549480676651, -0.01750546135008335, -0.06579914689064026, -0.01742597296833992, 0.005759283434599638, -0.04210466891527176, -0.0011940458789467812, -0.03597795590758324, 0.0043464102782309055, -0.036843907088041306, -0.05503784492611885, -0.021100593730807304, 0.015498962253332138, -0.05499850586056709, -0.002360357204452157, -0.04453577473759651, -0.02912261337041855, -0.02648230642080307, -0.02218860201537609, -0.01099453866481781, -0.029642967507243156, -0.04407264292240143, -0.02034035325050354, -0.04038979113101959, -0.027621714398264885, -0.040136802941560745, 0.016504675149917603, 0.014708182774484158, -0.03671430051326752, -0.05611591786146164, -0.045055877417325974, 0.023224685341119766, 0.01519504189491272, -0.04236452281475067, -0.02772008813917637, -0.04662468284368515, -0.006978699471801519, -0.05983695387840271, -0.02233465388417244, -0.014281029812991619, -0.07038358598947525, -0.02777351252734661, -0.0374869704246521, -0.03288644179701805, -0.004192241933196783, -0.05552458018064499, -0.009634644724428654, -0.01223660632967949, -0.0834251418709755, -0.037785280495882034, 0.01909620501101017, -0.008201885037124157, -0.010380342602729797, -0.03937128931283951, -0.07027383893728256, -0.024359865114092827, -0.04555150121450424, -0.032386403530836105, -0.04497012868523598, -0.0341055653989315, -0.019487036392092705, 0.003012889064848423, -0.03229415416717529, -0.01217277254909277, 0.005799140315502882, -0.05228332802653313, 0.0030487391632050276, -0.02802124246954918, -0.05804552882909775, -0.05338207632303238, -0.03644696995615959, -0.02358325943350792, -0.018628939986228943, 0.0006956325378268957, -0.04729984328150749, -0.02044796198606491, -0.01208839938044548, -0.013969306834042072, 0.0015148071106523275, 0.017660122364759445, -0.02010086551308632, -0.035474441945552826, -0.024433203041553497, -0.043606169521808624, -0.020909877493977547, -0.031222503632307053, -0.08469001948833466, -0.03352687507867813, -0.03887425735592842, -0.043984442949295044, 0.010926551185548306, -0.031268805265426636, -0.011922785080969334, -0.03395954892039299, 0.012812181375920773, -0.03248004987835884, -0.038477636873722076, -0.05338883027434349, -0.04468163475394249, -0.0745243951678276, -0.021016931161284447, -0.07212567329406738, -0.016450218856334686, -0.050546541810035706, -0.025025159120559692, -0.04857474938035011, -0.010455097071826458, -0.04116014391183853, -0.007228696718811989, -0.046722669154405594, -0.023593159392476082]
)

        print(result_embeddings.tolist())
        print(result_text)

    def test_process_invalid_url(self):
        video_id = "video_2"
        video_link = "invalid_url"

        with self.assertRaises(Exception) as context:
            self.audio_processor.process(video_id, video_link)

        self.assertEqual(str(context.exception), "Failed to download video or audio")


if __name__ == "__main__":
    unittest.main()
